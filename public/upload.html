<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>upload</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      font: 14px / 1.2 "Microsoft Yahei"
    }
    
    ul, ol {
      list-style-type: none;
    }
    
    .panel {
      position: relative;
      margin: 50px;
    }
    
    .label {
      position: relative;
      display: block;
      width: 100%;
      height: 50px;
      line-height: 50px;
      font-size: 20px;
      color: #fff;
      border-radius: 6px;
      text-align: center;
      background-color: green;
      cursor: pointer;
    }
    
    img {
      /*display: block;*/
      /*margin-right: 10px;*/
    }
    
    /*.images {*/
    /*display: flex;*/
    /*justify-content: flex-start;*/
    /*align-items: center;*/
    /*margin-top: 30px;*/
    /*}*/
    
    /*.images img {*/
    /*display: block;*/
    /*flex: 0 0 calc(100% / 5);*/
    /*width: calc(100% / 5);*/
    /*height: auto;*/
    /*border: 0;*/
    /*}*/
  </style>
</head>
<body>

<div class="panel">
  <label class="label">
    <span>上传文件</span>
    <input class="f" type="file" hidden multiple>
  </label>
  <div class="images">
  </div>
  <div style="width: 100%;height: 10px;"></div>
  <!--<div class="avss">-->
  <!---->
  <!--</div>-->


</div>
<script src="exif.js"></script>
<script src="autoOrientation.js"></script>
<script src="upload11.js"></script>
<script src="imageTools.js"></script>
<script src="upload.js"></script>
<script>
  var doc = document
  var btn = doc.querySelector('.label')
  var input = doc.querySelector('.f')
  var imgList = doc.querySelector('.images')
  var tool = new ImageTool()
  
  // var cvs = doc.getElementById('cvs')
  // var cvsctx = cvs.getContext('2d')
  
  imgList.addEventListener('dblclick', function (e) {
    var target = e.target
    console.log(target.tagName)
    if (target && target.tagName === 'IMG') {
      target.parentNode.removeChild(target)
    }
  }, false)
  
  input.addEventListener('change', function () {
    console.log(this.files)
    var array = []
    var first = this.files[0]
    console.group('original')
    console.log('original file size: %o', first.size)
    console.log('original file size format: %o', formatBytes(first.size))
    console.groupEnd()
    tool.getSegements(first, function (segements){
        console.log(segements)
      segements.forEach(function (item, i){
          console.group('s' + i)
        var view = new DataView(item)
        console.log('type:', is(item))
        console.log(toHex(view.getUint8(0)))
        console.log(toHex(view.getUint8(1)))
        console.log(toHex(view.getUint16(2)))
        console.log(formatBytes(view.getUint16(2) - 2))
        console.groupEnd()
      })
      // console.log()
      var buffer = new ArrayBuffer(2)
      var typed = new Uint8Array(buffer)
      typed.set([0xFF, 0xD8], 0)
      var args = [buffer].concat(segements)
      console.log(args)
      var bf = tool.concatArrayBuffer.apply(null, args)
      console.log(bf)
        var info = EXIF.readFromBinaryFile(bf)
      console.log(info)
    })
    
  }, false)
  
  function preview(src) {
    // console.log(src)
    var image = new Image()
    image.onload = function () {
      imgList.appendChild(this)
    }
    image.src = src
  }
  
  function toHex(n) {
    var val = n.toString(16).toUpperCase()
    return '0x' + (val.toString().length % 2 !== 0 ? '0' : '') + val
  }
  
  function upload(file) {
    var form = new FormData()
    var xhr = new XMLHttpRequest()
    form.append('file', file, 'tesla')
    xhr.open("post", '/upload', true);
    xhr.send(form);
  }
  
  function formatBytes(bytes) {
    if (bytes <= 0) {
      return 0;
    }
    var unit = 1024;
    var units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB', 'BB', 'NB', 'DB'];
    var exponent = Math.floor(Math.log(bytes) / Math.log(unit));
    var size = (bytes / Math.pow(unit, exponent)).toFixed(2);
    return exponent < units.length ? [size, units[exponent]].join('') : '1000+DB';
  }
  
  function fileToBase64(file, callback) {
    var reader = new FileReader()
    reader.onload = function () {
      typeof callback === 'function' && callback(this.result)
    }
    reader.readAsDataURL(file)
  }
  
  function fileToBlob(file, mime, callback) {
    fileToArrayBuffer(file, function (buffer) {
      var blob = new Blob(buffer, mime)
      typeof callback === 'function' && callback(blob)
    })
  }
  
  function fileToArrayBuffer(file, callback) {
    var reader = new FileReader()
    reader.onload = function () {
      typeof callback === 'function' && callback(this.result)
    }
    reader.readAsArrayBuffer(file)
  }
  
  function base64ToArrayBuffer(base64) {
    base64 = base64.replace(/^data\:([^\;]+)\;base64,/gmi, '');
    var binary = atob(base64);
    var size = binary.length;
    var buffer = new ArrayBuffer(size);
    var view = new Uint8Array(buffer);
    for (var i = 0; i < size; i++) {
      view[i] = binary.charCodeAt(i);
    }
    return buffer;
  }

  function is(value, type) {
    var c = {}.toString.call(value).slice(8, -1);
    return typeof type === 'string' ? type.toLowerCase() === c.toLowerCase() : c;
  }
  
</script>
</body>
</html>
